%%%% Data Files
image_folder = 'Caltech4/ImageData/';
test_files = 'Caltech4/ImageSets/test.txt';
%%%%

%%%%% Hyperparams
vocab_size = 400; % (800, 1600, 2000 and 4000)
use_dense = false; % (true, false)
sift_type = 'RGB'; % ('RGB','rgb','opponent','gray','hsv')
kernel = 'RBF';
num_vocab = 2; % vocab fraction
num_train = 2; % number of images used from each class for training svm
step_size = 10;
block_size = 10;
%%%%%


%%%%% Feature files
dense = 'kp';
if use_dense
    dense = 'dense';
end
feature_folder = 'Caltech4/FeatureData/';


ds_file = strcat(feature_folder, 'ds_vsize-', num2str(vocab_size), '_SIFT-',...
 sift_type,'_',dense,'ntrain-',num2str(num_train),'_kernel-',kernel,'.mat'); 
centroid_file = strcat(feature_folder, 'centroid_vsize-', num2str(vocab_size), '_SIFT-',...
 sift_type,'_',dense,'ntrain-',num2str(num_train),'_kernel-',kernel,'.mat');
x_train_file = strcat(feature_folder, 'xtrain_vsize-', num2str(vocab_size), '_SIFT-',...
 sift_type,'_',dense,'ntrain-',num2str(num_train),'_kernel-',kernel,'.mat');

%%%%%

disp('Fetching vocabulary and training files...');
[vocab_files, train_files] = construct_dataset(image_folder, num_vocab, num_train);

disp('Fetching test files..');
test_files = read_list(test_files);

disp('Constructing visual vocabulary..');
[centroids, stacked_ds] = build_vocab(vocab_files, vocab_size, use_dense, sift_type, step_size, block_size);

disp('Quantizing images..');
[train_h, train_l] = quantize_images(train_files, centroids, sift_type, use_dense, step_size, block_size);

disp('Training SVM classifiers..');
[svm1, svm2, svm3, svm4] = train_svms(train_h,train_l, kernel);

disp('Getting test set features...');
[test_h, test_l] = quantize_images(test_files, centroids, sift_type, use_dense, step_size, block_size);

disp('Classifying and analyzing results...');
[rankings, accuracies, map] = test_svms(test_h, test_l, test_files, svm1, svm2, svm3, svm4);

disp('Exporting results...');
export_results(rankings, accuracies, map, sift_type, use_dense,...
vocab_size, num_vocab, num_train, length(test_l), kernel);